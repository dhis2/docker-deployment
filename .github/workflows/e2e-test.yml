name: E2E Test

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  e2e-test:
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        dhis2_version: [ 42, 41, 40 ]
      max-parallel: 1
    name: E2E Test DHIS2 v${{ matrix.dhis2_version }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure environment
        run: |
          ./scripts/generate-env.sh
          cat .env | sed '/^#/d' >> $GITHUB_ENV

          ./scripts/install-loki-driver.sh
        env:
          GEN_APP_HOSTNAME: dhis2-127-0-0-1.nip.io
          GEN_LETSENCRYPT_ACME_EMAIL: whatever@dhis2.org

      - name: E2e test
        env:
          DHIS2_VERSION: ${{ matrix.dhis2_version }}
        run: |
          make playwright
          make test
