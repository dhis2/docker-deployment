---
name: Docker Smoke Test

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  smoke-test:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - name: Configure environment
        run: |
          ./scripts/generate_env.sh
          cat .env | sed /^#/d >> $GITHUB_ENV

          ./scripts/install-loki-driver.sh

      - name: Start services
        run: |
          docker compose -f docker-compose.yml -f overlays/docker-compose.traefik-dashboard.yml -f overlays/docker-compose.monitoring.yml up -d

      - name: Wait for all services to be healthy
        run: |
          docker compose ps
          timeout 60 bash -c '
          echo "Waiting for all services to be healthy..."
          while true; do
            all_healthy=true
            for name in $(docker compose ps --format "{{.Name}}"); do
              echo "Checking $name..."
              status=$(docker inspect "$name" --format "{{.State.Health.Status}}")
              if [ "$status" != "healthy" ]; then
                echo "Service $name is $status, waiting..."
                all_healthy=false
                break
              fi
            done
            if $all_healthy; then
              echo "All services are healthy."
              break
            fi
            sleep 5
          done
          '

      - name: Wait for application to be ready
        run: |
          timeout 2m bash -c 'until curl --silent --fail http://dhis2-127-0-0-1.nip.io/dhis-web-login/; do sleep 5; done'

      - name: Verify process isn't running as root
        run: |
          USER=$(docker compose exec -T app whoami)
          echo "Container user: $USER"
          [ "$USER" != "root" ]

      - name: Verify process is running as PID 1
        run: |
          DHIS2_PID=$(docker compose exec -T app pgrep java | head -n 1)
          echo "DHIS2 process PID: $DHIS2_PID"
          [ "$DHIS2_PID" = "1" ]

      - name: Debug on failure
        if: failure()
        run: |
          echo "=== Container Status ==="
          docker compose ps -a
          echo "=== App Logs (last 50 lines) ==="
          docker compose logs app --tail=50
          echo "=== Database Logs (last 20 lines) ==="
          docker compose logs database --tail=20
