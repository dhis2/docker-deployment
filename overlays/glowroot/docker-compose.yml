services:
  app:
    depends_on:
      glowroot-init:
        condition: service_completed_successfully
    volumes:
      - glowroot-data:/opt/glowroot
    environment:
      JDK_JAVA_OPTIONS: "${JDK_JAVA_OPTIONS:-} -javaagent:/opt/glowroot/glowroot.jar"
    ports:
      - "127.0.0.1:4000:4000"

  glowroot-init:
    image: curlimages/curl:${CURL_VERSION:-8.10.1}
    volumes:
      - glowroot-data:/opt/glowroot
      - ./overlays/glowroot/config/admin.json:/tmp/admin.json:ro
      - ./overlays/glowroot/glowroot-init.sh:/tmp/glowroot-init.sh:ro
    environment:
      GLOWROOT_VERSION: ${GLOWROOT_VERSION:-0.14.4}
      EXPECTED_SHA: ${EXPECTED_SHA:-3b9db6b0fc0903233c5e17b6cfa7b022ef8ba6d71ae7d39a9fff6f637608f20c}
      APP_UID: ${APP_UID:-65534}
      APP_GID: ${APP_GID:-65534}
    command: [ "sh", "/tmp/glowroot-init.sh" ]
    user: root
    security_opt:
      - no-new-privileges:true

volumes:
  glowroot-data: {}
